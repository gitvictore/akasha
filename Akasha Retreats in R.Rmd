---
title: 'Aldeia Akasha: Ayahuasca, Wellbeing, and Connectedness'
output:
  html_document:
    toc: true
    css: "akasha-styles.css"
    self_contained: true
    includes:
      before_body: title.html
      in_header: favicon.html
    theme: flatly
    toc_depth: 4
  md_document:
    preserve_yaml: false
  pdf_document:
    toc: true
    toc_depth: '4'
always_allow_html: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# ---- Libraries ----
library(dplyr)
library(tidyr)
library(table1)
library(shiny)
library(glue)
library(plotly)
library(knitr)
library(skimr)
library(kableExtra)
library(ggthemes)
library(forcats)
library(scales)
library(tidyr)
library(cluster)
library(stringr)
library(ggplot2)
library(emmeans)
library(lme4)
library(purrr)
library(readxl)
library(sysfonts)
library(showtext)

# ---- Set universal fonts ----
font_add_google("Lato", "lato")
showtext_auto()

# Set Lato as the default ggplot2 font
theme_set(theme_minimal(base_family = "lato"))
update_geom_defaults("text",   list(family = "lato"))
update_geom_defaults("label",  list(family = "lato"))
update_geom_defaults("point",  list(family = "lato"))

# ---- Basev Import and Clean ----
basev <- read_excel(
  "~/Documents/Akasha/baseline-values 6-30-2025.xlsx",
  col_types = c(
    "skip", # Start Date
    "skip", # End Date
    "skip", # Response Type
    "skip", # IP Address
    "skip", # Progress
    "skip", # Duration (in seconds)
    "numeric", # Finished
    "date", # Recorded Date
    "text", # Response ID
    "skip", # Recipient Last Name
    "skip", # Recipient First Name
    "skip", # Recipient Email
    "skip", # External Data Reference
    "skip", # Location Latitude
    "skip", # Location Longitude
    "skip", # Distribution Channel
    "skip", # User Language
    "skip", # consent
    "skip", # retreat - Selected Choice
    "skip", # retreat - Not displayed - Text
    "numeric", # age
    "skip", # gender - Selected Choice
    "skip", # gender - Not listed - Text
    "text", # Text (country of origin)
    "text", # Text (country of residence)
    "skip", # education
    "skip", # language - Selected Choice
    "skip", # language - Not listed - Text
    "text", # Text (religion or faith)
    "skip", # practices - Selected Choice
    "skip", # practices - Not listed (please specify) - Text
    rep("numeric", 15), # wellbeing items
    "skip", # previous ayahuasca
    "skip", # intention - Selected Choice
    "skip", # intention - Mental health (e.g., depression, anxiety, addiction) - Text
    "skip", # intention - Physical health (e.g., chronic pain) - Text
    "skip", # intention - Not listed - Text
    rep("numeric", 11), # connectedness items
    "text", # connection definition
    "skip", # IMPORTANT: Before clicking Submit… Participant ID: [Field-…]
    "skip", # Score
    "text" # Participant ID
  ),
  skip = 1 # skip the extra row in Qualtrics
) %>%
  rename(
    bl_recorded_date = "Recorded Date",
    bl_response_id = "Response ID",
    country_origin = "Text...5",
    country_residence = "Text...6",
    religion = "Text...7",
    bl_conn_def = "connection definition",
    pid = "Participant ID",
    `bl_wb_1 - I have felt calm and at peace.` =
      "baseline wellbeing - I have felt calm and at peace.",
    `bl_wb_2 - I have felt irritable or easily frustrated.` =
      "baseline wellbeing - I have felt irritable or easily frustrated.",
    `bl_wb_3 - I have experienced feelings of loneliness.` =
      "baseline wellbeing - I have experienced feelings of loneliness.",
    `bl_wb_4 - I have felt down, depressed, or hopeless.` =
      "baseline wellbeing - I have felt down, depressed, or hopeless.",
    `bl_wb_5 - I have felt anxious or \"on edge\".` =
      "baseline wellbeing - I have felt anxious or \"on edge\".",
    `bl_wb_6 - I have experienced physical pain or discomfort.` =
      "baseline wellbeing - I have experienced physical pain or discomfort.",
    `bl_wb_7 - I have had difficulty concentrating or focusing.` =
      "baseline wellbeing - I have had difficulty concentrating or focusing.",
    `bl_wb_8 - I have had difficulty sleeping.` =
      "baseline wellbeing - I have had difficulty sleeping.",
    `bl_wb_9 - I have found it easy to make decisions.` =
      "baseline wellbeing - I have found it easy to make decisions.",
    `bl_wb_10 - I have felt motivated to accomplish daily tasks.` =
      "baseline wellbeing - I have felt motivated to accomplish daily tasks.",
    `bl_wb_11 - I have felt a sense of purpose or meaning in life.` =
      "baseline wellbeing - I have felt a sense of purpose or meaning in life.",
    `bl_wb_12 - I have experienced moments of awe or transcendence.` =
      "baseline wellbeing - I have experienced moments of awe or transcendence.",
    `bl_wb_13 - I have been overall satisfied with my life.` =
      "baseline wellbeing - I have been overall satisfied with my life.",
    `bl_wb_14 - I have felt supported by my social network.` =
      "baseline wellbeing - I have felt supported by my social network.",
    `bl_wb_15 - I have experienced conflict or tension in my relationships.` =
      "baseline wellbeing - I have experienced conflict or tension in my relationships.",
    `bl_nsc_1 - I feel emotionally connected to the natural world.` =
      "connectedness - I feel emotionally connected to the natural world.",
    `bl_nsc_2 - I view humans as separate from nature.` =
      "connectedness - I view humans as separate from nature.",
    `bl_nsc_3 - I notice and appreciate the small details of nature (e.g., plants, animals, weather).` =
      "connectedness - I notice and appreciate the small details of nature (e.g., plants, animals, weather).",
    `bl_nsc_4 - I feel a sense of awe and wonder when in nature.` =
      "connectedness - I feel a sense of awe and wonder when in nature.",
    `bl_nsc_5 - I feel motivated to make choices that are more environmentally friendly (e.g., recycling, conserving energy).` =
      "connectedness - I feel motivated to make choices that are more environmentally friendly (e.g., recycling, conserving energy).",
    `bl_nsc_6 - I feel a strong spiritual bond with the Earth and its living beings.` =
      "connectedness - I feel a strong spiritual bond with the Earth and its living beings.",
    `bl_nsc_7 - I feel connected to others.` =
      "connectedness - I feel connected to others.",
    `bl_nsc_8 - I feel disconnected from others.` =
      "connectedness - I feel disconnected from others.",
    `bl_nsc_9 - I feel like I belong.` =
      "connectedness - I feel like I belong.",
    `bl_nsc_10 - I feel understood by others.` =
      "connectedness - I feel understood by others.",
    `bl_nsc_11 - I feel connected to my community.` =
      "connectedness - I feel connected to my community."
  ) %>%
  mutate(
    bl_recorded_date_r = as.Date(bl_recorded_date),
    retreat = case_when(
      bl_recorded_date_r <= as.Date("2025-02-07") ~ "Ninawa",
      bl_recorded_date_r <= as.Date("2025-02-14") ~ "Colibri Festival",
      bl_recorded_date_r <= as.Date("2025-03-02") ~ "Tumã",
      bl_recorded_date_r <= as.Date("2025-04-25") ~ "Nixiwaka",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(Finished != 0) %>%
  mutate(
    timepoint = "Baseline"
  ) %>%
  relocate(c(pid, bl_response_id, retreat), .before = 1) %>%
  select(-Finished, -bl_recorded_date_r)

# ---- Basetxt Import and Clean ----
basetxt <- read_excel(
  "~/Documents/Akasha/baseline-labels 6-30-2025.xlsx",
  skip = 1,
  col_types = c(
    "skip", # Start Date
    "skip", # End Date
    "skip", # Response Type
    "skip", # IP Address
    "skip", # Progress
    "skip", # Duration (in seconds)
    "skip", # Finished
    "skip", # Recorded Date
    "text", # Response ID
    "skip", # Recipient Last Name
    "skip", # Recipient First Name
    "skip", # Recipient Email
    "skip", # External Data Reference
    "skip", # Location Latitude
    "skip", # Location Longitude
    "skip", # Distribution Channel
    "skip", # User Language
    "skip", # consent
    "skip", # retreat - Selected Choice
    "skip", # retreat - Not displayed - Text
    "skip", # age
    "text", # gender - Selected Choice
    "text", # gender - Not listed - Text
    "skip", # Text (country of origin)
    "skip", # Text (country of residence)
    "text", # education
    "text", # language - Selected Choice
    "text", # language - Not listed - Text
    "skip", # What is your religion or belief system?
    "text", # practices - Selected Choice
    "text", # practices - Not listed (please specify) - Text
    rep("skip", 15), # skip the wellbeing items
    "text", # previous ayahuasca
    "text", # intention - Selected Choice
    "text", # intention - Mental health (e.g., depression, anxiety, addiction) - Text
    "text", # intention - Physical health (e.g., chronic pain) - Text
    "text", # intention - Not listed - Text
    rep("skip", 11), # connectedness items
    "skip", # connection definition
    "skip", # IMPORTANT: Before clicking Submit… Participant ID: [Field-…]
    "skip", # Score
    "skip" # Participant ID
  )
) %>%
  rename(
    prev_ayahuasca = "previous ayahuasca",
    intention = "intention - Selected Choice",
    intent_mental = "intention - Mental health (e.g., depression, anxiety, addiction) - Text",
    intent_physical = "intention - Physical health (e.g., chronic pain) - Text",
    intent_other = "intention - Not listed - Text",
    lang_sel = "language - Selected Choice",
    lang_txt = "language - Not listed - Text",
    gender = "gender - Selected Choice",
    gender_other = "gender - Not listed - Text",
    practices = "practices - Selected Choice",
    practices_other = "practices - Not listed (please specify) - Text"
  ) %>%
  mutate(
    # if they chose “Not listed”, language_not_listed will be non-NA,
    # otherwise it’ll be NA – so coalesce will pick the custom text first
    lang_txt = na_if(lang_txt, ""),
    language = coalesce(lang_txt, lang_sel),
    gender_other = na_if(gender_other, ""),
    gender = coalesce(gender_other, gender),
    practices_other = na_if(practices_other, ""),
    practices = coalesce(practices_other, practices)
  ) %>%
  select(-lang_sel, -lang_txt, -gender_other, -practices_other) %>%
  relocate(`Response ID`, .before = 1)

# ---- Follow-up Import and Clean ---- ----
fu <- read_excel(
  "~/Documents/Akasha/follow-up 6-30-2025.xlsx",
  col_types = c(
    "skip", # Start Date
    "skip", # End Date
    "skip", # Response Type
    "skip", # IP Address
    "skip", # Progress
    "skip", # Duration (in seconds)
    "numeric", # Finished
    "date", # Recorded Date
    "text", # Response ID
    "skip", # Recipient Last Name
    "skip", # Recipient First Name
    "skip", # Recipient Email
    "skip", # External Data Reference
    "skip", # Location Latitude
    "skip", # Location Longitude
    "skip", # Distribution Channel
    "skip", # User Language
    "skip", # consent
    "skip", # What is the Participant ID you were given at the end of your first questionnaire? - Selected Choice
    "text", # What is the Participant ID you were given at the end of your first questionnaire? - My Participant ID is... - Text
    "skip", # age
    "skip", # gender - Selected Choice
    "skip", # gender - Not listed - Text
    "skip", # Country of Origin
    "skip", # Country of Residence
    "skip", # education
    "skip", # language - Selected Choice
    "skip", # language - Not listed - Text
    "skip", # Religion
    "skip", # practices - Selected Choice
    "skip", # practices - Not listed (please specify) - Text
    "numeric", # after ceremony feeling - Relaxed and at peace
    "numeric", # after ceremony feeling - Connected to myself
    "numeric", # after ceremony feeling - Connected to others
    "numeric", # after ceremony feeling - Emotionally balanced
    "numeric", # after ceremony feeling - Insightful about my life or challenges
    "numeric", # after ceremony feeling - Confused and disoriented
    "text", # helpful aspects of ceremony
    "text", # greatest emotion
    "numeric", # ceremonial setting aspects - Presence of Nixiwaka
    "numeric", # ceremonial setting aspects - Presence of Putanny
    "numeric", # ceremonial setting aspects - Rituals and prayers (e.g., group healing, smudging, tobacco offerings)
    "numeric", # ceremonial setting aspects - Group setting (versus individual/alone)
    "numeric", # ceremonial setting aspects - Music (e.g., ícaros, drumming)
    "numeric", # ceremonial setting aspects - Physical environment (e.g., nature, ceremonial room)
    "numeric", # ceremonial setting aspects - Sharing circle insights
    "numeric", # ceremonial setting aspects - Immediate neighbor(s)
    "numeric", # ceremony enhanced ayahuasca
    "numeric", # In my opinion, similar effects could be achieved without a ceremonial setting.
    "text", # ceremonial setting one word
    "numeric", # connectedness - I feel emotionally connected to the natural world.
    "numeric", # connectedness - I view humans as separate from nature.
    "numeric", # connectedness - I notice and appreciate the small details of nature (e.g., plants, animals, weather).
    "numeric", # connectedness - I feel a sense of awe and wonder when in nature.
    "numeric", # connectedness - I feel motivated to make choices that are more environmentally friendly (e.g., recycling, conserving energy).
    "numeric", # connectedness - I feel a strong spiritual bond with the Earth and its living beings.
    "numeric", # connectedness - I feel connected to others.
    "numeric", # connectedness - I feel disconnected from others.
    "numeric", # connectedness - I feel like I belong.
    "numeric", # connectedness - I feel understood by others.
    "numeric", # connectedness - I feel connected to my community.
    "text", # connection definition
    "skip", # IMPORTANT: Before clicking Submit… Participant ID: [Field-…]
    "skip", # Score
    "text" # Participant ID
  ),
  skip = 1
) %>%
  mutate(
    timepoint = "Follow-up"
  ) %>%
  rename(
    pid_auto = "Participant ID",
    pid_manual = "What is the Participant ID you were given at the end of your first questionnaire? - My Participant ID is... - Text",
    fu_conn_def_txt = "connection definition",
    fu_recorded_date = `Recorded Date`,
    fu_response_id = `Response ID`,
    fu_ceremony_enhanced_ayahuasca = `ceremony enhanced ayahuasca`,
    fu_ceremonial_setting_one_word_txt = `ceremonial setting one word`,
    fu_of_1_relaxed_and_at_peace = `after ceremony feeling - Relaxed and at peace`,
    fu_of_2_connected_to_self = `after ceremony feeling - Connected to myself`,
    fu_of_3_connected_to_others = `after ceremony feeling - Connected to others`,
    fu_of_4_emotionally_balanced = `after ceremony feeling - Emotionally balanced`,
    fu_of_5_insightful = `after ceremony feeling - Insightful about my life or challenges`,
    fu_of_6_confused = `after ceremony feeling - Confused and disoriented`,
    fu_similar_effects = `In my opinion, similar effects could be achieved without a ceremonial setting.`,
    fu_helpful_aspects_txt = `helpful aspects of ceremony`,
    fu_greatest_emotion_txt = `greatest emotion`,
    `fu_nsc_1 - I feel emotionally connected to the natural world.` =
      "connectedness - I feel emotionally connected to the natural world.",
    `fu_nsc_2 - I view humans as separate from nature.` =
      "connectedness - I view humans as separate from nature.",
    `fu_nsc_3 - I notice and appreciate the small details of nature (e.g., plants, animals, weather).` =
      "connectedness - I notice and appreciate the small details of nature (e.g., plants, animals, weather).",
    `fu_nsc_4 - I feel a sense of awe and wonder when in nature.` =
      "connectedness - I feel a sense of awe and wonder when in nature.",
    `fu_nsc_5 - I feel motivated to make choices that are more environmentally friendly (e.g., recycling, conserving energy).` =
      "connectedness - I feel motivated to make choices that are more environmentally friendly (e.g., recycling, conserving energy).",
    `fu_nsc_6 - I feel a strong spiritual bond with the Earth and its living beings.` =
      "connectedness - I feel a strong spiritual bond with the Earth and its living beings.",
    `fu_nsc_7 - I feel connected to others.` =
      "connectedness - I feel connected to others.",
    `fu_nsc_8 - I feel disconnected from others.` =
      "connectedness - I feel disconnected from others.",
    `fu_nsc_9 - I feel like I belong.` =
      "connectedness - I feel like I belong.",
    `fu_nsc_10 - I feel understood by others.` =
      "connectedness - I feel understood by others.",
    `fu_nsc_11 - I feel connected to my community.` =
      "connectedness - I feel connected to my community.",
    fu_setting_Presence_Shaman = `ceremonial setting aspects - Presence of Nixiwaka`,
    fu_setting_Presence_Putany = `ceremonial setting aspects - Presence of Putanny`,
    fu_setting_Rituals_Prayers = `ceremonial setting aspects - Rituals and prayers (e.g., group healing, smudging, tobacco offerings)`,
    fu_setting_Group_Setting = `ceremonial setting aspects - Group setting (versus individual/alone)`,
    fu_setting_Music = `ceremonial setting aspects - Music (e.g., ícaros, drumming)`,
    fu_setting_Physical_Environment = `ceremonial setting aspects - Physical environment (e.g., nature, ceremonial room)`,
    fu_setting_Sharing_Circle = `ceremonial setting aspects - Sharing circle insights`,
    fu_setting_Immediate_Neighbors = `ceremonial setting aspects - Immediate neighbor(s)`
  ) %>%
  relocate(c(pid_auto, pid_manual, fu_response_id, fu_recorded_date, timepoint), .before = 1) %>%
  filter(Finished != 0) %>%
  select(-Finished)

# ---- One-month Import and Clean ---- ----

omo <- read_excel("~/Documents/Akasha/one-month 6-30-2025.xlsx",
  col_types = c(
    "skip", # Start Date
    "skip", # End Date
    "skip", # Response Type
    "skip", # IP Address
    "skip", # Progress
    "skip", # Duration (in seconds)
    "numeric", # Finished
    "date", # Recorded Date
    "text", # Response ID
    "skip", # Recipient Last Name
    "skip", # Recipient First Name
    "skip", # Recipient Email
    "skip", # External Data Reference
    "skip", # Location Latitude
    "skip", # Location Longitude
    "skip", # Distribution Channel
    "skip", # User Language
    "skip", # consent
    "skip", # What is the Participant ID you were given at the end of your first questionnaire? - Selected Choice
    "text", # What is the Participant ID you were given at the end of your first questionnaire? - My Participant ID is... - Text
    "skip", # age
    "skip", # gender - Selected Choice
    "skip", # gender - Not listed - Text
    "skip", # Text (country of origin)
    "skip", # Text (country of residence)
    "skip", # education
    "skip", # language - Selected Choice
    "skip", # language - Not listed - Text
    "skip", # Text (any other language)
    "skip", # practices - Selected Choice
    "skip", # practices - Not listed (please specify) - Text
    "numeric", # overall feeling - Relaxed and at peace
    "numeric", # overall feeling - Connected to myself
    "numeric", # overall feeling - Connected to others
    "numeric", # overall feeling - Emotionally balanced
    "numeric", # overall feeling - Insightful about my life or challenges
    "numeric", # overall feeling - Confused and disoriented
    "text", # greatest emotion
    "numeric", # connectedness - I feel emotionally connected to the natural world.
    "numeric", # connectedness - I view humans as separate from nature.
    "numeric", # connectedness - I notice and appreciate the small details of nature (e.g., plants, animals, weather).
    "numeric", # connectedness - I feel a sense of awe and wonder when in nature.
    "numeric", # connectedness - I feel motivated to make choices that are more environmentally friendly (e.g., recycling, conserving energy).
    "numeric", # connectedness - I feel a strong spiritual bond with the Earth and its living beings.
    "numeric", # connectedness - I feel connected to others.
    "numeric", # connectedness - I feel disconnected from others.
    "numeric", # connectedness - I feel like I belong.
    "numeric", # connectedness - I feel understood by others.
    "numeric", # connectedness - I feel connected to my community.
    "numeric", # baseline wellbeing - I have felt calm and at peace.
    "numeric", # baseline wellbeing - I have felt irritable or easily frustrated.
    "numeric", # baseline wellbeing - I have experienced feelings of loneliness.
    "numeric", # baseline wellbeing - I have felt down, depressed, or hopeless.
    "numeric", # baseline wellbeing - I have felt anxious or "on edge".
    "numeric", # baseline wellbeing - I have experienced physical pain or discomfort.
    "numeric", # baseline wellbeing - I have had difficulty concentrating or focusing.
    "numeric", # baseline wellbeing - I have had difficulty sleeping.
    "numeric", # baseline wellbeing - I have found it easy to make decisions.
    "numeric", # baseline wellbeing - I have felt motivated to accomplish daily tasks.
    "numeric", # baseline wellbeing - I have felt a sense of purpose or meaning in life.
    "numeric", # baseline wellbeing - I have experienced moments of awe or transcendence.
    "numeric", # baseline wellbeing - I have been overall satisfied with my life.
    "numeric", # baseline wellbeing - I have felt supported by my social network.
    "numeric", # baseline wellbeing - I have experienced conflict or tension in my relationships.
    "skip", # IMPORTANT: Before clicking Submit… Participant ID: [Field-…]
    "skip", # Score
    "text" # Participant ID
  ),
  skip = 1
) %>%
  mutate(
    timepoint = "1-Month"
  ) %>%
  rename(
    pid_auto = "Participant ID",
    pid_manual = "What is the Participant ID you were given at the end of your first questionnaire? - My Participant ID is... - Text",
    omo_response_id = `Response ID`,
    omo_recorded_date = `Recorded Date`,
    omo_greatest_emotion_txt = `greatest emotion`,
    omo_of_1_relaxed_and_at_peace = `overall feeling - Relaxed and at peace`,
    omo_of_2_connected_to_self = `overall feeling - Connected to myself`,
    omo_of_3_connected_to_others = `overall feeling - Connected to others`,
    omo_of_4_emotionally_balanced = `overall feeling - Emotionally balanced`,
    omo_of_5_insightful = `overall feeling - Insightful about my life or challenges`,
    omo_of_6_confused = `overall feeling - Confused and disoriented`,
    `omo_nsc_1 - I feel emotionally connected to the natural world.` =
      "connectedness - I feel emotionally connected to the natural world.",
    `omo_nsc_2 - I view humans as separate from nature.` =
      "connectedness - I view humans as separate from nature.",
    `omo_nsc_3 - I notice and appreciate the small details of nature (e.g., plants, animals, weather).` =
      "connectedness - I notice and appreciate the small details of nature (e.g., plants, animals, weather).",
    `omo_nsc_4 - I feel a sense of awe and wonder when in nature.` =
      "connectedness - I feel a sense of awe and wonder when in nature.",
    `omo_nsc_5 - I feel motivated to make choices that are more environmentally friendly (e.g., recycling, conserving energy).` =
      "connectedness - I feel motivated to make choices that are more environmentally friendly (e.g., recycling, conserving energy).",
    `omo_nsc_6 - I feel a strong spiritual bond with the Earth and its living beings.` =
      "connectedness - I feel a strong spiritual bond with the Earth and its living beings.",
    `omo_nsc_7 - I feel connected to others.` =
      "connectedness - I feel connected to others.",
    `omo_nsc_8 - I feel disconnected from others.` =
      "connectedness - I feel disconnected from others.",
    `omo_nsc_9 - I feel like I belong.` =
      "connectedness - I feel like I belong.",
    `omo_nsc_10 - I feel understood by others.` =
      "connectedness - I feel understood by others.",
    `omo_nsc_11 - I feel connected to my community.` =
      "connectedness - I feel connected to my community.",
    `omo_wb_1 - I have felt calm and at peace.` =
      "baseline wellbeing - I have felt calm and at peace.",
    `omo_wb_2 - I have felt irritable or easily frustrated.` =
      "baseline wellbeing - I have felt irritable or easily frustrated.",
    `omo_wb_3 - I have experienced feelings of loneliness.` =
      "baseline wellbeing - I have experienced feelings of loneliness.",
    `omo_wb_4 - I have felt down, depressed, or hopeless.` =
      "baseline wellbeing - I have felt down, depressed, or hopeless.",
    `omo_wb_5 - I have felt anxious or \"on edge\".` =
      "baseline wellbeing - I have felt anxious or \"on edge\".",
    `omo_wb_6 - I have experienced physical pain or discomfort.` =
      "baseline wellbeing - I have experienced physical pain or discomfort.",
    `omo_wb_7 - I have had difficulty concentrating or focusing.` =
      "baseline wellbeing - I have had difficulty concentrating or focusing.",
    `omo_wb_8 - I have had difficulty sleeping.` =
      "baseline wellbeing - I have had difficulty sleeping.",
    `omo_wb_9 - I have found it easy to make decisions.` =
      "baseline wellbeing - I have found it easy to make decisions.",
    `omo_wb_10 - I have felt motivated to accomplish daily tasks.` =
      "baseline wellbeing - I have felt motivated to accomplish daily tasks.",
    `omo_wb_11 - I have felt a sense of purpose or meaning in life.` =
      "baseline wellbeing - I have felt a sense of purpose or meaning in life.",
    `omo_wb_12 - I have experienced moments of awe or transcendence.` =
      "baseline wellbeing - I have experienced moments of awe or transcendence.",
    `omo_wb_13 - I have been overall satisfied with my life.` =
      "baseline wellbeing - I have been overall satisfied with my life.",
    `omo_wb_14 - I have felt supported by my social network.` =
      "baseline wellbeing - I have felt supported by my social network.",
    `omo_wb_15 - I have experienced conflict or tension in my relationships.` =
      "baseline wellbeing - I have experienced conflict or tension in my relationships."
  ) %>%
  relocate(c(pid_auto, pid_manual, omo_response_id, omo_recorded_date, timepoint), .before = 1) %>%
  filter(Finished != 0) %>%
  select(-Finished)

# ---- pid coalescing before merge ---- ----

fu <- fu %>%
  mutate(
    pid_auto   = sub("\\.0$", "", pid_auto),
    pid_manual = sub("\\.0$", "", pid_manual),
    pid = coalesce(pid_manual, pid_auto)
  ) %>%
  relocate(c(pid_auto, pid_manual, pid, fu_response_id), .before = 1)

omo <- omo %>%
  mutate(
    pid_auto   = sub("\\.0$", "", pid_auto),
    pid_manual = sub("\\.0$", "", pid_manual),
    pid = coalesce(pid_manual, pid_auto)
  ) %>%
  relocate(c(pid_auto, pid_manual, pid, omo_response_id), .before = 1)

# ---- Manual matching ---- ----

# remove Michèle's test submission from baseline
basev <- basev %>%
  filter(bl_response_id != "R_6teomARAyFf1gge")

# fu, originally 46. manually matched one person, manually fixed another with a typo, one is dropped for not completing baseline.
fu <- fu %>%
  mutate( 
    pid = case_when(
      fu_response_id == "R_6e3J8ppiX1jtPs2" ~ "418328", # demographic match to baseline
      pid_manual == "566132" ~ "565132", # typo assumed to be same person because of retreat and only off by one number
      TRUE ~ pid
    )
  ) %>%
  select(-pid_auto, -pid_manual)

# omo, manually matched 3 ppl and will drop one for not completing baseline
omo <- omo %>%
  mutate(
    pid = case_when(
      omo_response_id == "R_3sTqbmgs0GDHhA0" ~ "391644", # demographic match to baseline
      omo_response_id == "R_407wj0qqBiCHFbI" ~ "774750", # demographic match to baseline
      omo_response_id == "R_8IKuKnBB3V9ZQm1" ~ "495946", # demographic match to baseline
      TRUE ~ pid
    )
  ) %>%
  select(-pid_auto, -pid_manual)
```

```{r audit for completion, eval=FALSE, include=FALSE}
# Who’s in Follow-up but not Baseline?
lost_fu <- fu %>% 
  anti_join(basev, by = "pid")

# Who’s in One-Month but not Baseline?
lost_omo <- omo %>%
  anti_join(basev, by = "pid")

# Combine
lost <- bind_rows(
  lost_fu  %>% mutate(Source = "Follow-up"),
  lost_omo %>% mutate(Source = "One-month")
)

# View the offending rows
lost %>% 
  select(pid, Source) %>% 
  distinct()
```

```{r baseline merge, include=FALSE}
# Join the baselines

baseline <- basev %>%
  left_join(
    basetxt,
    by     = c("bl_response_id" = "Response ID"),
    suffix = c("", "_txt")
  ) %>%
  relocate(
    
  # 1) IDs and timing
  pid,
  bl_response_id,
  bl_recorded_date,
  retreat,
  timepoint,
  
  # 2) Demographics
  age,
  gender,
  education,
  language,
  country_origin,
  country_residence,
  religion,
  
  
  # 4) Baseline experiences & intentions
  prev_ayahuasca,
  practices,
  intention,
  intent_mental,
  intent_physical,
  intent_other,
  bl_conn_def,
  
  .before = everything()
)
```

```{r demographics factoring, include=FALSE}

baseline <- baseline %>%
  mutate(
    # Standardize Country of Origin
    country_origin = case_when(
      country_origin %in% c("Brasil", "Brazil")                                ~ "Brazil",
      country_origin %in% c("United States", "United States of America", "USA")~ "United States",
      country_origin %in% c("Britain", "England")                              ~ "United Kingdom",
      country_origin == "México"                                               ~ "Mexico",
      country_origin == "France and Lebanon"                                   ~ "France",
      TRUE                                                                      ~ country_origin
    ),
    
    # Standardize Country of Residence
    country_residence = case_when(
      country_residence %in% c("Brasil", "Brazil")                             ~ "Brazil",
      country_residence %in% c("United States", "United States of America", "USA") ~ "United States",
      country_residence %in% c("Britain", "England", "Wales", "UK/India")      ~ "United Kingdom",
      TRUE                                                                      ~ country_residence
    ),

    # Retreats in chronological order
    retreat = factor(
      retreat,
      levels = c("Ninawa", "Colibri Festival", "Tumã", "Nixiwaka")
    ),
    
    gender = factor(gender),

    education = factor(
      education,
      levels = c(
        "Primary (Elementary)",
        "Upper Secondary (High)",
        "Vocational",
        "Bachelor's",
        "Master's",
        "Doctoral"
      ),
      ordered = TRUE
    ),

    # reorder & drop unused country levels
    country_origin    = fct_infreq(country_origin),
    country_residence = fct_infreq(country_residence),

    # reorder & drop unused intention levels
    intention = fct_infreq(intention),
    intention = fct_drop(intention),

    # Past ayahuasca experience (renamed prev_ayahuasca)
    prev_ayahuasca = factor(
      prev_ayahuasca,
      levels = c(
        "Never",
        "One time",
        "2–5 times",
        "6–10 times",
        "More than 10 times"
      ),
      ordered = TRUE
    ),
  
    # binary flag for spiritual intent
    spiritual_intent = if_else(intention == "Spiritual growth", 1L, 0L),

    # high vs low group on ayahuasca experience
    experience_group = fct_collapse(
      prev_ayahuasca,
      Low  = c("Never", "One time", "2–5 times"),
      High = c("6–10 times", "More than 10 times")
    )
  )
```

```{r all_wide join, include=FALSE}
colnames(baseline)
colnames(fu)
colnames(omo)

all_wide <- baseline %>%
  left_join(fu, by = "pid", suffix = c("", ".fu")) %>%
  left_join(omo, by = "pid", suffix = c("", ".omo")) %>%
  select(-c(timepoint.omo, timepoint.fu))
```

```{=html}
<!-- # Abstract
[draft abstract]

# Introduction
[draft literature review]
-->
```

# Methods

This pilot study administered **three (3) Questionnaires (*Baseline*, *Follow-up*, and *One-Month*)** to participants at **four ceremonial ayahuasca retreats** held at **Aldeia Akasha in Petrópolis, Rio de Janeiro, Brazil** between January and April 2025. Each retreat included three **(3) separate ayahuasca ceremonies** conducted over the course of one week.

Participants completed the *Baseline* questionnaire electronically via Qualtrics at the start of the retreat, **prior to the first ceremony.** Informed consent was obtained through an affirmative response to the consent item included at the beginning of the first questionnaire. Due to its small scale and programmatic nature, the study did not undergo formal IRB review.

The *Baseline* questionnaire collected **demographic data** (age, gender, highest education level, country of origin and residence, primary language, religious affiliation, and prior spiritual or healing practices), **previous ayahuasca experience**, and participants’ **primary intention** for attending the ceremony. To accommodate an **internationally diverse audience**, the education Question included examples from various systems (e.g., *Ensino Fundamental*, *Lycée*, *Grundschule*), and Questionnaires were offered in both **English and Portuguese**.

Participants also completed a section on **recent wellbeing over the past two weeks** (e.g., calmness, irritability, anxiety, depressive symptoms, and life satisfaction) in both the *Baseline* and *One-Month* Questionnaires. A section measuring **nature and social connectedness** appeared in all three Questionnaires: *Baseline*, *Follow-up*, and *One-Month*.

All items used 5-point Likert scales (e.g., from "Strongly disagree" to "Strongly agree" or "Not at all important" to "Extremely important"). Within each section, items were presented in randomized order. Upon completing the *Baseline* questionnaire, participants were assigned an anonymous Participant ID for longitudinal tracking.

Immediately after the 3-ceremony retreat, participants received the *Follow-up* questionnaire, which captured immediate reflections. It repeated the *Baseline* measures of nature and social connectedness and included additional items on **emotional and cognitive effects** (e.g., feelings of peace, connectedness, emotional balance, and insights about personal challenges). Participants also rated the **importance of ceremonial elements**, including the presence of shamans, music, group rituals, and physical setting, on a 5-point Likert scale. Open-ended prompts invited participants to share **notable moments** and the **primary emotion** they experienced post-retreat.

Finally, the *One-Month* questionnaire reassessed recent **wellbeing, nature and social connectedness, and mental health status**, using identical items from earlier Questionnaires to allow for longtitudinal comparisons.

Data analysis and presentation of results were completed using RStudio Version 2025.05.0+496 in June – July 2025.

We gratefully acknowledge the generous support and collaboration of the **Guardians and support staff of Aldeia Akasha ([homepage](https://uniretreats.org/akasha-retreat-center/))**, without whose openness, cooperation, and hospitality this pilot study would not have been possible.

# Results

## Participant Overview

### Table 1: Baseline Participant Characteristics by Retreat

**Table 1** (below) reports demographic characteristics for the **62 participants** who completed the first *(Baseline)* questionnaire.

**Most participants were women (58.1%)** with an **average age of 42 years** (SD = 9.05, range 24–62). **Educational attainment was high**: over half had a bachelor's or master's degree (30.6% and 25.8%, respectively). The sample was **internationally diverse, with the largest groups originating from Brazil (30.6%)**, the United Kingdom (17.7%), and United States (16.1%).

**Ceremony intentions were led by spiritual growth (50.0%)**, followed by mental health (19.4%), and career (14.5%), with smaller proportions citing physical health (4.8%), curiosity (4.8%), or other purposes (6.3%). Prior ayahuasca experience varied widely: **over a third (35.5%) had taken ayahuasca 10+ times** while **one-fifth (17.7%) were first-timers**.

```{r table1, echo=FALSE}
## Table1 only from baseline retreat with matched participants

table1_selection <- baseline %>%
  select(
    retreat,
    gender,
    age,
    prev_ayahuasca,       # was PastAyahuasca
    intention,
    education,            # was HighestEducation
    country_origin,
    country_residence
  )

# Attach “label” attributes:
label(baseline$gender)            <- "Gender"
label(baseline$education)         <- "Highest education level"
label(baseline$country_origin)    <- "Country of origin"
label(baseline$country_residence) <- "Country of residence"
label(baseline$intention)         <- "Ceremony intention"
label(baseline$prev_ayahuasca)    <- "Times taken ayahuasca"
label(baseline$age)               <- "Age (years)"

table1(
  ~ gender
  + age
  + education
  + prev_ayahuasca
  + intention
  + country_origin
  + country_residence  | retreat,
  data    = baseline,
  overall = "Total"
)

```

### Table 2: Questionnaire Completion by Retreat

*Displaying only participants with IDs matched to baseline*

**Twenty-four (24) participants completed all three Questionnaires,** out of **62 total participants** who enrolled in the pilot**. Overall retention was thus 39%,** with retention varying by retreat from Tumã at 0% retention to Ninawa at 52% retention. *Follow-up* questionnaire retention averaged 73% overall, ranging from 43% for COLIBRI to 89% for Nixiwaka.

```{r table2 completion, echo=FALSE}
# 1) Define the desired order
ordered_levels <- c("Ninawa", "Colibri Festival", "Tumã", "Nixiwaka", "Total")

# 2) Compute raw counts
table2 <- baseline %>%
  group_by(retreat) %>%
  summarize(
    N_baseline = n_distinct(pid),
    N_fu       = sum(pid %in% fu$pid),
    N_omo      = sum(pid %in% omo$pid),
    .groups    = "drop"
  )

# 3) Totals
total_baseline <- sum(table2$N_baseline)
total_fu       <- sum(table2$N_fu)
total_omo      <- sum(table2$N_omo)

# 4) Build display rows for non-Total
display <- table2 %>%
  filter(retreat != "Total") %>%
  mutate(
    Baseline  = as.character(N_baseline),
    `Follow-up` = sprintf(
      "%d (%d%%)", N_fu,
      round(100 * N_fu / N_baseline)
    ),
    `1-Mo`    = sprintf(
      "%d (%d%%)", N_omo,
      round(100 * N_omo / N_baseline)
    )
  ) %>%
  select(retreat, Baseline, `Follow-up`, `1-Mo`)

# 5) Append Total row with counts only
display <- bind_rows(
  display,
  tibble(
    retreat      = "Total",
    Baseline     = as.character(total_baseline),
    `Follow-up`  = sprintf(
      "%d (%d%%)",
      total_fu,
      round(100 * total_fu / total_baseline)
    ),
    `1-Mo`       = sprintf(
      "%d (%d%%)",
      total_omo,
      round(100 * total_omo / total_baseline)
    )
  )
)

# 6) Order and render
display %>%
  mutate(retreat = factor(retreat, levels = ordered_levels)) %>%
  arrange(retreat) %>%
  kable(
    format    = "html",
    align     = c("l", "r", "r", "r"),
    col.names = c(
      "Retreat",
      "Baseline (n, %)",
      "Follow-up (n, % retention)",
      "1-Mo (n, % retention)"
    )
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    full_width        = TRUE,
    position          = "left"
  ) %>%
  row_spec(nrow(display), bold = TRUE)

```

```{r prep timepoint comparison, echo=FALSE}
# 1) Bind all three waves with new prefixes (nsc_ and wb_)
all_raw <- bind_rows(
  baseline %>%
    mutate(timepoint = "Baseline") %>%
    select(
      pid, retreat, timepoint, prev_ayahuasca, intention,
      starts_with("bl_nsc_"), starts_with("bl_wb_")
    ),
  fu %>%
    mutate(timepoint = "Follow-up") %>%
    select(
      pid, timepoint,
      starts_with("fu_nsc_"), starts_with("fu_wb_")
    ),
  omo %>%
    mutate(timepoint = "One-month") %>%
    select(
      pid, timepoint,
      starts_with("omo_nsc_"), starts_with("omo_wb_")
    )
)

# 2) Pivot long
all_long <- all_raw %>%
  pivot_longer(
    cols      = -c(pid, timepoint, retreat, prev_ayahuasca, intention),
    names_to  = "Question_raw",
    values_to = "response"
  )

# 3) Split NATSC vs wellbeing by prefix
all_nat        <- all_long %>% filter(str_detect(Question_raw, "^.*_nsc_"))
all_wellbeing  <- all_long %>% filter(str_detect(Question_raw, "^.*_wb_"))


# define which Questions to invert
inv_nat <- c(
  "I view humans as separate from nature.",
  "I feel disconnected from others."
)
inv_wb <- c(
  "I have experienced feelings of loneliness.",
  "I have felt anxious or \"on edge\".",
  "I have had difficulty concentrating or focusing.",
  "I have experienced conflict or tension in my relationships.",
  "I have felt irritable or easily frustrated.",
  "I have felt down, depressed, or hopeless.",
  "I have experienced physical pain or discomfort.",
  "I have had difficulty sleeping."
)

# 5) Clean NATSC
cleaned_nat <- all_nat %>%
  mutate(
    Question = str_remove(Question_raw, "^.*_nsc_\\d+\\s*-\\s*"),
    Question = recode(
      Question,
      "I notice and appreciate the small details of nature (e.g., plants, animals, weather)." =
        "I notice and appreciate the small details of nature."
    ),
    # invert where needed
    response = if_else(Question %in% inv_nat, 6L - response, response),
    Question = if_else(
      Question %in% inv_nat,
      str_c(Question, " (inv.)"),
      Question
    )
  )

# 6) Clean wellbeing
cleaned_wb <- all_wellbeing %>%
  mutate(
    Question = Question_raw %>%
      str_remove("^.*_wb_") %>%            # drop everything through "_wb_"
      str_remove("^\\d+\\s*-\\s*"),        # drop leading "1 - " (or "2 - ", etc)
    response = if_else(Question %in% inv_wb, 6L - response, response),
    Question = if_else(Question %in% inv_wb,
      str_c(Question, " (inv.)"),
      Question
    )
  )

# Commented this out because it isn't used anywhere
# # 7) Full cleaned for combined use
# cleaned_all <- bind_rows(
#   cleaned_nat   %>% select(pid, retreat, timepoint, Question, response),
#   cleaned_wb    %>% select(pid, retreat, timepoint, Question, response)
# )

# 8) Summaries
summary_nat <- cleaned_nat %>%
  group_by(Question, timepoint) %>%
  summarize(mean_response = mean(response, na.rm = TRUE), .groups = "drop")

summary_wb <- cleaned_wb %>%
  group_by(Question, timepoint) %>%
  summarize(mean_response = mean(response, na.rm = TRUE), .groups = "drop") %>%
  filter(timepoint != "Follow-up")
```

### Who's Taken Ayahuasca Before, and Why?

#### Chart 1: How Many Times Have Participants Taken Ayahuasca?

Chart 1 displays the frequency of prior ayahuasca experience among participants at *Baseline* (*n*=63). The largest group reported taking ayahuasca **more than 10 times (23 participants, 37%)**, followed by those who had never taken it (13 participants, 21%). Smaller proportions had taken it once (17%), 6–10 times (14%), or 2–5 times (11%). Overall, the sample includes both ayahuasca-naive and experienced participants, with a notable concentration at both extremes of experience.

```{r ayahuasca frequency, echo=FALSE, fig.align='left', fig.width=10}

freq <- baseline %>%
  count(prev_ayahuasca) %>%
  arrange(match(prev_ayahuasca,
    c("Never","One time","2–5 times","6–10 times","More than 10 times")
  )) %>%
  mutate(
    pct = n / sum(n),
    label = paste0(n, " (", scales::percent(pct, accuracy = 1), ")"),
    prev_ayahuasca = factor(
      prev_ayahuasca,
      levels = rev(
        c("Never","One time","2–5 times","6–10 times","More than 10 times")
      )
    )
  )

ggplot(freq, aes(x = prev_ayahuasca, y = n)) +
  geom_col(fill = "#A8D5BA", width = 0.7) +
  geom_text(
    aes(label = label),
    hjust = -0.1,
    color = "black",
    size = 4
  ) +
  scale_y_continuous(expand = expansion(c(0, .1))) +
  coord_flip() +
  labs(
    x = "# Participants",
    y = "Times Taken Ayahuasca"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.minor     = element_blank(),
    panel.grid.major.y   = element_blank(),
    axis.text.x          = element_blank(),
    axis.ticks.x         = element_blank(),
    plot.title           = element_text(face = "bold", size = 16, hjust = 0.5),
    axis.text            = element_text(size = 12)
  )
```

#### Chart 2: Why are Participants Taking Ayahuasca?

**Spiritual growth** was the most common intention across nearly all experience levels. It dominated especially among participants with more ayahuasca experience, making up **56%** of intentions among those who had taken it 6–10 times and **68%** among those with 10+ experiences. **Career-related** intentions appeared fairly evenly across groups, while curiosity and physical health were mentioned only by a few participants. Interestingly, in the "2–5 times" group, **mental health** was the leading intention (57%), suggesting that participants newer to ayahuasca may engage with it initially for psychological reasons before shifting toward more spiritually framed goals. Overall, while intention profiles are broadly similar, experience level seems to shape the relative prominence of certain motivations, especially the increasing focus on spiritual growth with repeated use.

```{r ayahuasca-by-intention, echo=FALSE, fig.align='left'}

# Prepare counts + proportions
intention_freq <- baseline %>%
  count(prev_ayahuasca, intention) %>%
  group_by(prev_ayahuasca) %>%
  mutate(
    prop = n / sum(n),
    text = paste0(
      "Experience: ", prev_ayahuasca, "<br>",
      "Intention:  ", intention,      "<br>",
      "Count:      ", n,              "<br>",
      "Percent:    ", scales::percent(prop, 1)
    )
  ) %>%
  ungroup() %>%
  mutate(
    prev_ayahuasca = factor(
      prev_ayahuasca,
      levels = c("Never","One time","2–5 times","6–10 times","More than 10 times")
    )
  )

ggplot(intention_freq, aes(
  x    = prev_ayahuasca,
  y    = prop,
  fill = intention
)) +
  geom_col(color = "white", position = "fill", width = 0.7) +
  geom_text(
    aes(label = ifelse(prop >= 0.08, scales::percent(prop, 1), "")),
    position = position_fill(vjust = 0.5),
    color    = "black",
    size     = 3.5
  ) +
  scale_y_continuous(
    labels = scales::percent_format(),
    expand = expansion(0)
  ) +
  scale_fill_brewer(palette = "Set2") +
  coord_flip() +
  labs(
    x     = "Times Taken Ayahuasca",
    y     = "Proportion of Intentions",
    fill  = "Ceremony Intention",
    title = "Intentions by Prior Ayahuasca Experience at Baseline",
    caption = expression(italic(n) == 62)
  ) +
  theme_light(base_size = 13) +
  theme(
    axis.title.y     = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position  = "bottom"
  )

# graveyard of tested charts (collapsed via RStudio's **Join Lines** feature: Ctrl+Shift+J)
# ggplot(intention_freq, aes(x = prev_ayahuasca, y = prop, fill = intention)) +
#   geom_col(width = 0.7, color = "white") + facet_wrap(~ intention, ncol = 2) +
#   scale_y_continuous(labels = scales::percent_format(accuracy = 1), expand = expansion(0)) +
#   scale_fill_brewer(palette = "Set2", guide = "none") +
#   labs(x = "Prior Ayahuasca Experience", y = "Proportion of Respondents",
#        title = "Proportion of Each Intention by Prior Ayahuasca Experience") +
#   theme_light(base_size = 13) +
#   theme(panel.grid.minor    = element_blank(),
#         axis.text.x         = element_text(angle = 30, hjust = 1))
#
# ggplot(intention_freq, aes(x = intention, y = prev_ayahuasca, fill = prop)) +
#   geom_tile(color = "white") +
#   geom_text(aes(label = scales::percent(prop, accuracy = 1)), color = "black", size = 3.5) +
#   scale_fill_viridis_c(option = "D", direction = -1) +
#   labs(x = "Ceremony Intention", y = "Prior Ayahuasca Experience",
#        fill = "Proportion", title = "Distribution of Intentions by Prior Ayahuasca Experience") +
#   theme_light(base_size = 13) +
#   theme(panel.grid          = element_blank(),
#         axis.text.x        = element_text(angle = 30, hjust = 1))
```

```{r spiritual intention testing, echo=FALSE}
tbl <- table(baseline$experience_group,
             baseline$spiritual_intent)

fisher.test(tbl, alternative = "two.sided")
```

Indeed, participants with high ayahuasca experience (6 previous ceremonies or more, *n* = 31) had significantly greater odds of reporting spiritual-growth intent compared to those with low experience. A Fisher’s Exact Test indicated that the odds of choosing spiritual intent were **3.2 times higher** in the high-experience group than in the low-experience group (odds ratio = 3.24, 95% CI: 1.04 to 10.67, *p* = 0.041\*). Because the confidence interval does not include 1, this suggests a statistically significant association between past ayahuasca use and reported spiritual motivation. While the wide confidence interval reflects the limited data in this pilot, these results provide evidence of an association worth further study.

## Nature & Social Connectedness

[copy about this section and what it was intended to do, maybe reference the other scales we used]

### Table 3: How Participants' Nature and Social Connectedness Evolved After Retreat

Mean response on each **Nature and Social Connectedness** section at three timepoints, where 5 = Strongly Agree and 1 = Strongly Disagree.

```{r chart: naturesocial across timepoints, echo=FALSE, fig.width=16, fig.height=8}
labeltextsize <- 6

### nat
ggplot(summary_nat, aes(x = timepoint, y = mean_response, group = 1)) +
  geom_line(color = "gray40") +
  geom_point(aes(color = timepoint), size = 3) +
  geom_text(
    aes(label = sprintf("%.2f", mean_response)),
    color = "black",
    vjust = 2.0,
    size = labeltextsize
  ) +
  facet_wrap(
    ~ Question,
    nrow   = 2,
    scales = "fixed",
    labeller = label_wrap_gen(width = 20)
  ) +
  scale_y_continuous(limits = c(1, 5), breaks = 1:5) +
  scale_color_manual(
    values = c(
      "Baseline"  = "#ace3a6",
      "Follow-up" = "#2eb51f",
      "One-month" = "#116b07"
    )
  ) +
  theme_minimal(base_size = 20) +
  theme(
    panel.spacing    = unit(0.5, "lines"),
    panel.border     = element_rect(color = "black", linewidth = 0.6, fill = NA),
    strip.text       = element_text(face = "bold"),
    axis.text.x      = element_text(angle = 45, hjust = 1),
    panel.grid.major = element_line(color = "gray90"),
    legend.position  = "none"
  ) +
  labs(
    x = NULL,
    y = "Mean response (1–5)"
  )

```

### Table 4: Mixed Models on Nature and Social Connectedness

Table 4 summarizes paired comparisons between *Baseline* and both subsequent Questionnaires (*Follow-up* and *One-month*) across 11 Questions on **Nature and Social connectedness**.

Statistically significant improvements (*p* \< .05) were found primarily in items related to social connectedness. One month after their retreats, participants reported large **reductions in feelings of disconnection from others** (**β = -1.04**, *p* \< .001\*\*\*), in addition to increases in their feeling of **being understood by others** (**β = -1.01**, *p* \<.001\*\*\*) and **sense of belonging** (**β = -0.68**, *p* \< .01\*\*). Participants also reported moderate increases in their **sense of connection to others** (**β = -0.48**, *p* \< .011\*) and to their community (**β = -0.60**, *p* \< .01\*\*). Many of these effects were already apparent at *Follow-up* and persisted or strengthened by *One-month*.

In contrast, most items measuring **nature connectedness**, such as feelings of awe and wonder in nature or spiritual bonds with the Earth, showed no significant changes. A notable exception was the item “*I notice and appreciate the small details of nature*,” (**β = -0.28**, *p* \< .01\*\*)) which showed a slight but significant improvement, indicating that participants experienced enhanced attentiveness to subtle aspects of the natural world one month after the retreat.

Overall, these results suggest the retreat mostly had a **broad and substantial impact on social connectedness**, in addition to benefitting an appreciation of the small details of nature.

```{r table: nature-social lmm, echo=FALSE}
results_nat_complete <- cleaned_nat %>%
  # only keep pid/timepoint/Question/response
  select(pid, timepoint, Question, response) %>%
  # for reproducibility, ensure timepoint is a factor in the right order
  mutate(timepoint = factor(timepoint, levels = c("Baseline", "Follow-up", "One-month"))) %>%
  # nest by Question
  nest_by(Question) %>%
  mutate(
    # fit LMM
    model = list(lmer(response ~ timepoint + (1 | pid), data = data, REML = FALSE)),
    # emmeans + pairwise contrasts
    em = list(emmeans(model, ~timepoint)),
    contrasts = list(as.data.frame(contrast(em, method = "pairwise", adjust = "none")))
  ) %>%
  # unnest the contrasts
  select(Question, contrasts) %>%
  ungroup() %>%
  unnest(contrasts)

slim_results_nat <- results_nat_complete %>%
  mutate(
    contrast = str_replace(contrast, " - ", " to "),
    contrast = str_remove_all(contrast, "\\(|\\)"),
    Estimate = round(estimate, 2),
    SE       = round(SE, 2),
    DF       = round(df, 1),
    t_value  = round(t.ratio, 2),
    p_fmt    = case_when(
      p.value < 0.001 ~ "<.001",
      p.value < 0.01  ~ "<.01",
      TRUE            ~ sprintf("%.3f", p.value)
    ),
    stars = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    p_colored = case_when(
      p.value < 0.001 ~ cell_spec(paste0(p_fmt, stars), color = "white", background = "#5E4FA2", bold = TRUE),
      p.value < 0.01  ~ cell_spec(paste0(p_fmt, stars), color = "white", background = "#3288BD", bold = TRUE),
      p.value < 0.05  ~ cell_spec(paste0(p_fmt, stars), color = "black", background = "#ABDDA4"),
      TRUE            ~ paste0(p_fmt, stars)
    ),
    Estimate_colored = case_when(
      p.value < 0.001 ~ cell_spec(sprintf("%.2f", Estimate), color = "white", background = "#5E4FA2", bold = TRUE),
      p.value < 0.01  ~ cell_spec(sprintf("%.2f", Estimate), color = "white", background = "#3288BD", bold = TRUE),
      p.value < 0.05  ~ cell_spec(sprintf("%.2f", Estimate), color = "black", background = "#ABDDA4"),
      TRUE            ~ sprintf("%.2f", Estimate))
  ) %>%
  filter(contrast != "Follow-up to One-month") %>%
  select(
    Question,
    Contrast = contrast,
    Estimate = Estimate_colored,
    SE,
    DF,
    `p value` = p_colored
  )

k <- kable(
  slim_results_nat,
  format = "html",
  escape = FALSE,
  align = c("l", "l", "r", "r", "r", "r"),
  col.names = c("Question", "Timeline Pair", "Estimate", "SE", "DF", "p-value")
) %>%
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    position = "left"
  ) %>%
  footnote(
    general = "Significance codes: * p < .05; ** p < .01; *** p < .001"
  )

# font-size rearrangement loop
for (i in seq_len(ncol(slim_results_nat))) {
  k <- k %>% column_spec(i, extra_css = "font-size: 15px;")
}

k
```

## Recent Wellbeing

[copy about this section]

### Table 5: How Participants' Recent Wellbeing Evolved After Retreat

Mean response on each **Recent Wellbeing** section at two timepoints, where 5 = Strongly Agree and 1 = Strongly Disagree. Note that recent wellbeing Questions were not asked at *Follow-up*, only at *Baseline* and *One-month*.

```{r chart: wellbeing across timepoints, echo=FALSE, fig.width=16, fig.height=14}
## wellbeing

ggplot(summary_wb, aes(timepoint, mean_response, group = 1)) +
  geom_line(color = "gray40") +
  geom_point(aes(color = timepoint), size = 5) +
  geom_text(
    aes(label = sprintf("%.2f", mean_response)),
    color = "black",
    vjust = -1.0,
    size = labeltextsize
  ) +
  facet_wrap(~Question,
    nrow = 3, scales = "fixed",
    labeller = label_wrap_gen(width = 20)
  ) +
  scale_y_continuous(limits = c(1, 5), breaks = 1:5) +
  scale_color_manual(
    values = c(
      "Baseline"   = "#A6CEE3",
      "One-month"  = "#08306B"
    )
  ) +
  theme_minimal(base_size = 20) +
  theme(
    panel.spacing    = unit(0.5, "lines"),
    panel.border     = element_rect(color = "black", linewidth = 0.6, fill = NA),
    strip.text       = element_text(face = "bold"),
    axis.text.x      = element_text(angle = 45, hjust = 1),
    panel.grid.major = element_line(color = "gray90"),
    legend.position  = "none"
  ) +
  labs(
    x = NULL,
    y = "Mean response (1–5)"
  )
```

### Table 6: Mixed Models on Recent Wellbeing

Participants showed **broad and statistically significant** improvements across emotional, existential, and cognitive domains from baseline to one month following the retreat. As shown in *Table 6*, participants reported **reduced symptoms of psychological distress**, including **loneliness** (β = -0.59, p \< .001\*\*\*) and anxiety (β = -0.49, p \< .01\*\*), depression (β = -0.44, p \< .01\*\*), difficulty concentrating (β = -0.41, p \< .01\*\*), and irritability (β = -0.37, p = .032\*). These estimates (β) represent decreases of roughly one-third to over half a scale point on the 5-point Likert scale used, corresponding to **moderate to large effect sizes.**

Positive shifts were also observed in life satisfaction (β = -0.49, p = .013\*), calmness and peace (β = -0.61, p \< .01\*\*), and ease making decisions (β = -0.50, p = .023\*). Participants also reported **more frequent experiences of awe or transcendence** (β = -0.80, p \< .001\*\*\*), a change close to a full scale point, suggesting a particularly strong impact in this domain.

Other outcomes including sense of purpose, physical discomfort, sleep quality, and perceived social support trended in a positive direction, but did not reach statistical significance. No change was observed in relationship conflict. Taken together, these results suggest a broad and meaningful **improvement in psychological wellbeing, emotional regulation, and existential engagement** one month after the retreat.

```{r table: wellness lmm, echo=FALSE}
results_wb_complete <- cleaned_wb %>%
  # only keep pid/timepoint/Question/response
  select(pid, timepoint, Question, response) %>%
  # for reproducibility, ensure timepoint is a factor in the right order
  mutate(timepoint = factor(timepoint, levels = c("Baseline", "One-month"))) %>%
  # nest by Question
  nest_by(Question) %>%
  mutate(
    # fit LMM
    model = list(lmer(response ~ timepoint + (1 | pid), data = data, REML = FALSE)),
    # emmeans + pairwise contrasts
    em = list(emmeans(model, ~timepoint)),
    contrasts = list(as.data.frame(contrast(em, method = "pairwise", adjust = "none")))
  ) %>%
  # unnest the contrasts
  select(Question, contrasts) %>%
  ungroup() %>%
  unnest(contrasts)

slim_results_wb <- results_wb_complete %>%
  mutate(
    contrast = str_replace(contrast, " - ", " to "),
    contrast = str_remove_all(contrast, "\\(|\\)"),
    Estimate = round(estimate, 2),
    SE       = round(SE, 2),
    DF       = round(df, 1),
    t_value  = round(t.ratio, 2),
    p_fmt    = case_when(
      p.value < 0.001 ~ "<.001",
      p.value < 0.01  ~ "<.01",
      TRUE            ~ sprintf("%.3f", p.value)
    ),
    stars = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    p_colored = case_when(
      p.value < 0.001 ~ cell_spec(paste0(p_fmt, stars), color = "white", background = "#5E4FA2", bold = TRUE),
      p.value < 0.01  ~ cell_spec(paste0(p_fmt, stars), color = "white", background = "#3288BD", bold = TRUE),
      p.value < 0.05  ~ cell_spec(paste0(p_fmt, stars), color = "black", background = "#ABDDA4"),
      TRUE            ~ paste0(p_fmt, stars)
    ),
    Estimate_colored = case_when(
      p.value < 0.001 ~ cell_spec(sprintf("%.2f", Estimate), color = "white", background = "#5E4FA2", bold = TRUE),
      p.value < 0.01  ~ cell_spec(sprintf("%.2f", Estimate), color = "white", background = "#3288BD", bold = TRUE),
      p.value < 0.05  ~ cell_spec(sprintf("%.2f", Estimate), color = "black", background = "#ABDDA4"),
      TRUE            ~ sprintf("%.2f", Estimate)
    )
  ) %>%
  select(
    Question,
    Contrast = contrast,
    Estimate = Estimate_colored,
    SE,
    DF,
    `p value` = p_colored
  )

kable(
  slim_results_wb,
  format = "html",
  escape = FALSE, # <-- important to render HTML from cell_spec
  align = c("l", "l", "r", "r", "r", "r"),
  col.names = c("Question", "Timeline Pair", "Estimate", "SE", "DF", "p-value")
) %>%
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    position = "left"
  ) %>%
  footnote(
    general = "Significance codes: * p < .05; ** p < .01; *** p < .001"
  )

```

## Ceremonial Setting

In the *Follow-up* questionnaire, participants were asked to reflect on the ceremonial contexts of their ayahuasca ceremonies. This section aimed to assess the perceived importance of various environmental and social elements within the ceremony. Participants rated eight aspects, including the presence of the shaman or *pajé* (e.g., Nixiwaka, Ninawa, Putanny), ritual elements (e.g., music, prayers), and contextual factors (e.g., group setting, physical space, sharing circles, and seat partners), on a 5-point Likert scale ranging from "Not at all important" to "Extremely important." These items were designed to capture how components of the setting may have contributed to participants’ subjective experience.

### Which aspects of the ceremony were most important to participants?

According to *Chart 3*, participants rated **Music highest** (more than 90% rated it "Extremely important"), followed by **Physical environment** and **Shaman presence** (around 88–95% “Strongly Agree/Agree”). **Rituals & prayers** and **Group setting** also skew positively.

By contrast, **Sharing circle** and especially **Immediate neighbors** had broader spreads. Only about half “Strongly Agree,” with larger "Neutral" and "Disagree" slices. The immediate proximity of other participants elicited the most neutral responses, with nearly half of participants selecting Neutral or below.

#### Chart 3: Distribution of Responses for Ceremonial Setting Section
```{r ceremonial setting clean, echo=FALSE, fig.align='left', fig.width=10}
# 1. Pivot all your ceremony aspects (including both shaman vars) long
ceremonies_long <- fu %>%
  select(
    pid,
    fu_setting_Presence_Shaman,
    fu_setting_Presence_Putany,
    fu_setting_Music,
    fu_setting_Rituals_Prayers,
    fu_setting_Group_Setting,
    fu_setting_Physical_Environment,
    fu_setting_Sharing_Circle,
    fu_setting_Immediate_Neighbors
  ) %>%
  pivot_longer(
    cols      = -pid,
    names_to  = "Raw_Aspect",
    values_to = "Rating"
  ) %>%
  filter(!is.na(Rating)) %>%
  mutate(
    Aspect = case_when(
      Raw_Aspect %in% c("fu_setting_Presence_Shaman", "fu_setting_Presence_Putany") ~ "Shaman presence",
      Raw_Aspect == "fu_setting_Music"            ~ "Music",
      Raw_Aspect == "fu_setting_Rituals_Prayers"  ~ "Rituals & prayers",
      Raw_Aspect == "fu_setting_Group_Setting"    ~ "Group setting",
      Raw_Aspect == "fu_setting_Physical_Environment" ~ "Physical environment",
      Raw_Aspect == "fu_setting_Sharing_Circle"   ~ "Sharing circle",
      Raw_Aspect == "fu_setting_Immediate_Neighbors" ~ "Immediate neighbors",
      TRUE                                         ~ Raw_Aspect
    ),
    Rating = factor(
      Rating,
      levels = 1:5,
      labels = c(
        "Not at all important",
        "Slightly important",
        "Moderately important",
        "Very important",
        "Extremely important"
      ),
      ordered = TRUE
    )
  )

# 2) Compute proportions
ceremony_prop <- ceremonies_long %>%
  count(Aspect, Rating) %>%
  group_by(Aspect) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup()

# 3) Compute the descending‐mean order
mean_order <- ceremonies_long %>%
  mutate(R_num = as.numeric(Rating)) %>%
  group_by(Aspect) %>%
  summarize(mean_rating = mean(R_num, na.rm = TRUE)) %>%
  arrange(mean_rating) %>%
  pull(Aspect)

# 4) Apply that ordering and plot
ceremony_prop <- ceremony_prop %>%
  mutate(Aspect = factor(Aspect, levels = mean_order))

ggplot(ceremony_prop, aes(x = Aspect, y = prop, fill = Rating)) +
  geom_col(color = NA) +
  coord_flip() +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(
    name   = "Importance",
    values = c(
      "Not at all important" = "#EFF3FF",
      "Slightly important"   = "#BDD7E7",
      "Moderately important" = "#6BAED6",
      "Very important"       = "#3182BD",
      "Extremely important"  = "#08519C"
    )
  ) +
  labs(x = NULL, y = "Percent of responses") +
  theme_minimal(base_size = 18)

# 5) Collapse into three broad categories
ceremonies_long <- ceremonies_long %>%
  mutate(
    Importance = case_when(
      Rating %in% c("Not at all important", "Slightly important") ~ "Less important",
      Rating == "Moderately important"                            ~ "Moderately important",
      TRUE                                                        ~ "Important"
    ),
    Importance = factor(
      Importance,
      levels = c("Less important", "Moderately important", "Important"),
      ordered = TRUE
    )
  )

# 6) Heat‐map of % by broad Importance
heatmap_df <- ceremonies_long %>%
  mutate(Aspect = factor(Aspect, levels = mean_order)) %>%
  count(Aspect, Importance) %>%
  group_by(Aspect) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup()

ggplot(heatmap_df, aes(x = Importance, y = Aspect, fill = prop)) +
  geom_tile(color = "white", linewidth = 0.2) +
  geom_text(aes(label = scales::percent(prop, accuracy = 0.1)), size = 6) +
  scale_fill_gradient(
    low  = "white",
    high = "#c76cd1",
    labels = scales::percent_format(accuracy = 1)
  ) +
  labs(x = NULL, y = NULL, fill = "Percent\nof responses") +
  theme_minimal(base_size = 18) +
  theme(panel.grid = element_blank(), legend.position = "none")

# 7) Print mean ratings
ceremonies_long %>%
  group_by(Aspect) %>%
  summarize(mean_rating = mean(as.numeric(Rating), na.rm = TRUE)) %>%
  arrange(desc(mean_rating))

# ggplot(ceremonies_long, aes(Rating, fill = Rating)) +
#   geom_bar() +
#   facet_wrap(~ExperienceGroup) 
```

```{r beep, message=FALSE, warning=FALSE, include=FALSE}
library(beepr)
beep()
```

````{=html}
<!--
## Sandbox

```{r violintest, eval=FALSE, include=FALSE}
ggplot(all_wide, aes(x = factor(prevayahuasca, y = Change_Anxiety)) +
        geom_violin() +
        labs(x = "Prior Ayahuasca Experience", y = "Change in Anxiety")
```

```{r reverse for all 3 points, eval=FALSE, include=FALSE}
## Graveyard
# Reverse for All 3 Points ------------------------------------------------
# Reverse "I feel disconnected from others"
basev$PRE_NATSC_8_rev <- 6 - basev$`PRE_NATSC_8 - connectedness - I feel disconnected from others.`
fu$FU_NATSC_8_rev <- 6 - fu$`FU_NATSC_8 - connectedness - I feel disconnected from others.`
omo$OMO_NATSC_8_rev <- 6 - omo$`OMO_NATSC_8 - connectedness - I feel disconnected from others.`

# Reverse "I view humans as separate from nature"
basev$PRE_NATSC_2_rev <- 6 - basev$`PRE_NATSC_2 - connectedness - I view humans as separate from nature.`
fu$FU_NATSC_2_rev <- 6 - fu$`FU_NATSC_2 - connectedness - I view humans as separate from nature.`
omo$OMO_NATSC_2_rev <- 6 - omo$`OMO_NATSC_2 - connectedness - I view humans as separate from nature.`

# Reverse loneliness
basev$PRE_BASELINE_3_rev <- 6 - basev$`PRE_BASELINE_3 - baseline wellbeing - I have experienced feelings of loneliness.`
omo$OMO_BASELINE_3_rev <- 6 - omo$`OMO_BASELINE_3 - baseline wellbeing - I have experienced feelings of loneliness.`

# Reverse conflict/tension in relationships
basev$PRE_BASELINE_15_rev <- 6 - basev$`PRE_BASELINE_15 - baseline wellbeing - I have experienced conflict or tension in my relationships.`
omo$OMO_BASELINE_15_rev <- 6 - omo$`OMO_BASELINE_15 - baseline wellbeing - I have experienced conflict or tension in my relationships.`

# Reverse physical pain or discomfort
basev$PRE_BASELINE_6_rev <- 6 - basev$`PRE_BASELINE_6 - baseline wellbeing - I have experienced physical pain or discomfort.`
omo$OMO_BASELINE_6_rev <- 6 - omo$`OMO_BASELINE_6 - baseline wellbeing - I have experienced physical pain or discomfort.`

# Reverse difficulty sleeping
basev$PRE_BASELINE_8_rev <- 6 - basev$`PRE_BASELINE_8 - baseline wellbeing - I have had difficulty sleeping.`
omo$OMO_BASELINE_8_rev <- 6 - omo$`OMO_BASELINE_8 - baseline wellbeing - I have had difficulty sleeping.`

# Reverse anxiety
basev$PRE_BASELINE_5_rev <- 6 - basev$`PRE_BASELINE_5 - baseline wellbeing - I have felt anxious or "on edge".`
omo$OMO_BASELINE_5_rev <- 6 - omo$`OMO_BASELINE_5 - baseline wellbeing - I have felt anxious or "on edge".`

# Reverse depression/hopelessness
basev$PRE_BASELINE_4_rev <- 6 - basev$`PRE_BASELINE_4 - baseline wellbeing - I have felt down, depressed, or hopeless.`
omo$OMO_BASELINE_4_rev <- 6 - omo$`OMO_BASELINE_4 - baseline wellbeing - I have felt down, depressed, or hopeless.`

# Reverse irritability/frustration
basev$PRE_BASELINE_2_rev <- 6 - basev$`PRE_BASELINE_2 - baseline wellbeing - I have felt irritable or easily frustrated.`
omo$OMO_BASELINE_2_rev <- 6 - omo$`OMO_BASELINE_2 - baseline wellbeing - I have felt irritable or easily frustrated.`

# Reverse difficulty concentrating
basev$PRE_BASELINE_7_rev <- 6 - basev$`PRE_BASELINE_7 - baseline wellbeing - I have had difficulty concentrating or focusing.`
omo$OMO_BASELINE_7_rev <- 6 - omo$`OMO_BASELINE_7 - baseline wellbeing - I have had difficulty concentrating or focusing.`

# Reverse "Confused and disoriented" after ceremony (FU only)
fu$FU_AFTER_CONFUSED_rev <- 6 - fu$`FU_AFTER_CONFUSED - after ceremony feeling - Confused and disoriented`
```
```{r fire and ice nsc, echo=FALSE, fig.width=10, eval = FALSE, include=FALSE, fig.height=30}
### "Fire and Ice" Gantt Chart: Nature and Social Connectedness

# prepare data
natsc_plot_data <- cleaned_nat %>%
    filter(!is.na(Response)) %>%     # drop the NAs
  mutate(
    Response = factor(Response,
      levels = 1:5,
      labels = c(
        "Strongly Disagree", "Disagree", "Neutral",
        "Agree", "Strongly Agree"
      ),
      ordered = TRUE
    )
  ) %>%
  group_by(Question, Timepoint, Response) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(Question, Timepoint) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(Timepoint = factor(Timepoint,
    levels = c("One-month", "Follow-up", "Baseline"),
    ordered = TRUE
  ))

# compute means for labels
nat_mean_df <- natsc_plot_data %>%
  group_by(Question, Timepoint) %>%
  summarise(
    mean_score = weighted.mean(as.integer(Response), n),
    mean_prop  = (mean_score - 1) / 4,
    .groups    = "drop"
  )

# Plot: now x = prop, y = Timepoint; facet by Question
natsc_plot <- ggplot(
  natsc_plot_data,
  aes(
    x    = prop,
    y    = Timepoint,
    fill = Response,
    text = glue("{Response}: {percent(prop, accuracy = 0.1)}")
  )
) +
  geom_vline(
    xintercept = 0.5,
    linetype = "dashed",
    color = "gray50",
    linewidth = 0.5
  ) +
  geom_bar(stat = "identity", position = "fill", color = NA) +
  geom_point(
    data = nat_mean_df,
    aes(x = mean_prop, y = Timepoint),
    inherit.aes = FALSE,
    shape = 21,
    fill = "black",
    color = NA,
    size = 8
  ) +
  geom_text(
    data = nat_mean_df,
    aes(x = mean_prop, y = Timepoint, label = round(mean_score, 1)),
    inherit.aes = FALSE,
    color = "white",
    size = 4,
    nudge_y = -0.04
  ) +
  scale_x_continuous(labels = scales::percent) +
  scale_fill_manual(
    values = c(
      "darkred", # Strongly Disagree
      "lightpink", # Disagree
      "gray80", # Neutral
      "skyblue", # Agree
      "darkblue" # Strongly Agree
    )
  ) +
  labs(x = "Proportion of responses", y = NULL) +
  coord_cartesian(expand = FALSE) +
  facet_wrap(~Question, ncol = 1, strip.position = "top") +
  theme_minimal(base_size = 16) +
  theme(
    panel.spacing = unit(2, "lines"),
    strip.text.x = element_text(
      face   = "bold",
      margin = margin(b = 20)
    ),
    axis.text.x = element_text(
      margin = margin(r = 20)
    )
  )

ggplotly(natsc_plot, tooltip = "text") %>%
  config(displayModeBar = FALSE) %>%
  layout(
    legend = list(
      orientation = "h", # horizontal
      x           = 0, # left-aligned
      xanchor     = "left",
      y           = -.025, # drop it below the plot area
      yanchor     = "top"
    )
  )
```

```{r fire and ice wellbeing, echo=FALSE, eval=FALSE, include=FALSE, fig.width=10, fig.height=30}
### "Fire and Ice" Gantt Chart: Wellbeing

wb_plot_data <- cleaned_wb %>%
  filter(!is.na(Response)) %>%
  mutate(
    Response = factor(Response,
      levels = 1:5,
      labels = c(
        "Strongly Disagree","Disagree","Neutral",
        "Agree","Strongly Agree"
      ),
      ordered = TRUE
    )
  ) %>%
  group_by(Question, Timepoint, Response) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(Question, Timepoint) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(Timepoint = factor(Timepoint,
    levels = c("Baseline","One-month"),
    ordered = TRUE
  ))

wb_mean_df <- wb_plot_data %>%
  group_by(Question, Timepoint) %>%
  summarise(
    mean_score = weighted.mean(as.integer(Response), n),
    mean_prop  = (mean_score - 1) / 4,
    .groups    = "drop"
  )


# Plot: now x = prop, y = Timepoint; facet by Question
wb_plot <- ggplot(
  wb_plot_data,
  aes(
    x    = prop,
    y    = Timepoint,
    fill = Response,
    text = glue("{Response}: {percent(prop, accuracy = 0.1)}")
  )
) +
  geom_vline(
    xintercept = 0.5,
    linetype = "dashed",
    color = "gray50",
    linewidth = 0.5
  ) +
  geom_bar(stat = "identity", position = "fill", color = NA) +
  # geom_point(
  #   data = wb_mean_df,
  #   aes(x = mean_prop, y = Timepoint),
  #   inherit.aes = FALSE,
  #   shape = 21,
  #   fill = "black",
  #   color = NA,
  #   size = 8
  # ) +
  # geom_text(
  #   data = wb_mean_df,
  #   aes(x = mean_prop, y = Timepoint, label = round(mean_score, 1)),
  #   inherit.aes = FALSE,
  #   color = "white",
  #   size = 4,
  #   nudge_y = -0.04
  # ) +
  scale_x_continuous(labels = scales::percent) +
  scale_fill_manual(
    values = c(
      "darkred", # Strongly Disagree
      "lightpink", # Disagree
      "gray80", # Neutral
      "skyblue", # Agree
      "darkblue" # Strongly Agree
    )
  ) +
  scale_y_discrete(
    limits = c("One-month", "Baseline")
  ) +
  labs(x = "Proportion of responses", y = NULL) +
  coord_cartesian(expand = FALSE) +
  facet_wrap(~Question, ncol = 1, strip.position = "top") +
  theme_minimal(base_size = 16) +
  theme(
    panel.spacing = unit(2, "lines"),
    strip.text.x = element_text(
      face   = "bold",
      margin = margin(b = 20)
    )
  )

ggplotly(wb_plot, tooltip = "text") %>%
  config(displayModeBar = FALSE) %>%
  layout(
    legend = list(
      orientation = "h", # horizontal
      x           = 0, # left-aligned
      xanchor     = "left",
      y           = -0.025, # drop it below the plot area
      yanchor     = "top"
    )
  )

```

```{r fire and ice plots, eval=FALSE, include=FALSE}
fire_ice_plot <- function(df,
                          time_levels,
                          show_mean = TRUE,
                          width      = 800,
                          height     = 2000) {
  # 1) prepare plotting data
  plot_data <- df %>%
    filter(!is.na(Response)) %>%
    mutate(
      Response = factor(Response,
        levels = 1:5,
        labels = c(
          "Strongly Disagree","Disagree","Neutral",
          "Agree","Strongly Agree"
        ),
        ordered = TRUE
      ),
      Timepoint = factor(Timepoint,
        levels = time_levels,
        ordered = TRUE
      )
    ) %>%
    group_by(Question, Timepoint, Response) %>%
    summarise(n = n(), .groups="drop_last") %>%
    mutate(prop = n / sum(n)) %>%
    ungroup()
  
  # 2) compute mean scores if requested
  mean_df <- plot_data %>%
    group_by(Question, Timepoint) %>%
    summarise(
      mean_score = weighted.mean(as.integer(Response), n),
      mean_prop  = (mean_score - 1) / 4,
      .groups    = "drop"
    )
  
  # 3) build ggplot
  p <- ggplot(plot_data,
    aes(
      x    = prop,
      y    = Timepoint,
      fill = Response,
      text = glue("{Response}: {percent(prop, accuracy=0.1)}")
    )
  ) +
    geom_vline(xintercept=0.5,
      linetype="dashed", color="gray50", size=0.5
    ) +
    geom_bar(stat="identity", position="fill", color=NA) +
    scale_x_continuous(labels=percent) +
    scale_fill_manual(values=c(
      "darkred","lightpink","gray80","skyblue","darkblue"
    )) +
    labs(x="Proportion of responses", y=NULL) +
    coord_cartesian(expand=FALSE) +
    facet_wrap(~Question, ncol=1, strip.position="top") +
    theme_minimal(base_size=16) +
    theme(
      panel.spacing   = unit(1.5,"lines"),
      strip.text.x    = element_text(face="bold", margin=margin(b=20)),
      axis.text.x     = element_text(margin=margin(t=5)),
      legend.position = "top"
    )
  
  # 4) optionally add mean‐dots + labels
  if (show_mean) {
    p <- p +
      geom_point(
        data=mean_df,
        aes(x=mean_prop, y=Timepoint),
        inherit.aes=FALSE,
        shape=21, fill="black", color=NA, size=6
      ) +
      geom_text(
        data=mean_df,
        aes(x=mean_prop, y=Timepoint, label=round(mean_score,1)),
        inherit.aes=FALSE,
        color="white", size=4, nudge_y=-0.04
      )
  }
  
  # 5) ggplotly wrapper
  ggplotly(p, tooltip="text", width=width, height=height) %>%
    config(displayModeBar = FALSE) %>%
    layout(
      legend = list(
        orientation="h",
        x=0, xanchor="left",
        y=-0.025, yanchor="top"
      )
    )
}

# Nature & Social Connectedness (3 timepoints)
fire_ice_plot(
  df          = cleaned_nat,
  time_levels = c("One-month","Follow-up","Baseline"),
  show_mean   = TRUE,
  width       = 800,
  height      = 2400
)

# Wellbeing (2 timepoints)
fire_ice_plot(
  df          = cleaned_wb,
  time_levels = c("One-month","Baseline"),
  show_mean   = FALSE,
  width       = 800,
  height      = 2000
)
```

```{r past experiences, eval=FALSE, include=FALSE}
# 1) Build a data.frame of differences
diffs <- cleaned_nat_complete %>%
  filter(Question == "I feel disconnected from others. (inv.)") %>%
  select(pid, Timepoint, Response) %>%
  pivot_wider(names_from = Timepoint, values_from = Response) %>%
  mutate(diff = Baseline - `One-month`) %>%
  drop_na(diff) %>%
  # now left-join PastAyahuasca from base_clean
  left_join(
    base_clean %>% select(pid, PastAyahuasca) %>% distinct(),
    by = "pid"
  )

skim(diffs)

# 2a) Histogram + density
ggplot(diffs, aes(x = diff)) +
  geom_histogram(aes(y = ..density..), bins = 8, color = "black", fill = "gray90") +
  geom_density(color = "blue", size = 1) +
  labs(
    x = "Baseline – One-month", y = "Density",
    title = "Distribution of Difference Scores"
  ) +
  theme_minimal()
```
-->
````
